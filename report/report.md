## 数据库系统概论项目报告

##### 2017011475 潘俊臣

##### 2017011474 郑林楷



#### 1、系统架构设计

![image-20191222234022767](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20191222234022767.png)

总体上数据库的架构与实验指导中的设计思路是类似的。

**页式文件系统**主要负责直接操作文件，按照页管理存储空间。

**查询解析模块**主要负责将SQL语句解析为对索引模块，系统管理模块，系统管理模块的操作。

#### 2、主要模块设计原理

##### （0）文件系统

​		文件系统利用给定的页式文件系统，

##### （1）记录管理模块

​		记录管理模块主要负责实现最基本的记录的增删改查，是直接操作文件系统的一个模块。记录管理模块中的操作都是朴素的。

**文件构成：**

$Sheet.cpp$ $Sheet.h $

**具体功能：**

1、表信息的存储

​		包括表头信息的存储和表内记录的存储。

​		表头信息以$Json$格式直接存储对应的数据库配置文件（$database.udb$）中，存储在所属数据库的$sheet$项内部，多个表按照$List$排列。每一个表的表头信息存储如下：

```json
{
    "col_num": 2,//列的个数
    "col_ty": [  //列的详细信息
        {
            "char_len": 0,
            "key": 2,
            "name": "id",
            "null": true,
            "ty": 0
        },
        {
            "char_len": 0,
            "key": 2,
            "name": "name",
            "null": true,
            "ty": 0
        }
    ],
    "index": [
        {
            "key": [
                0
            ],
            "key_num": 1,
            "name": "index1",
            "next_del_page": 4294967295,
            "offset": [
                0
            ],
            "page_num": 1,
            "record_size": 12,
            "root_page": 0,
            "ty": [
                0
            ]
        }
    ],
    "index_num": 0,//建立在本表的索引个数
    "name": "table1",//表的名字
    "p_key_index": -1,//表的主键索引号
    "record_num": 5,//表内存储的记录个数
    "record_onepg": 1008,//单个页最多存储的记录个数
    "record_size": 8//每个记录的长度（字节）
}
```

​		记录信息则使用页式管理系统，将记录存储在（$表名.usid$）中。存储中我们为了最大程度利用空间，除了最基本的把数据依次排列以外，还设计了$Exist$位和$isnull$位，存储在表的开头，分别占用$record\_per\_page$个比特的位置（按照字节向上取整），主要是为了标记对应的$record$是否有效（可能被删除）和标记对饮的$record$是否是空值。

2、增删改查

​		增：利用表头中的$record\_num$（相当于RID），计算找到页式文件系统中的对应位置存储即可。

​		删：直接对某一个ID计算标记位的位置，置1即可。

​		改：利用ID直接计算位置，修改对应的值即可。

​		查：利用ID直接计算位置返回结果即可

##### （2）索引模块

​	这个部分要负责实现索引的增删和维护，也是直接操作文件系统的一个模块。索引模块使用的是B树作为索引，对外提供创建索引，更新索引，利用索引查询等操作。

​		索引模块主要负责实现索引的增删和维护，也是直接操作文件系统的一个模块。索引模块使用的是B树作为索引，对外提供创建索引，更新索引，利用索引查询等操作。

##### 文件构成：

​		$BtreeNode.h$ $Index.h$ $Index.cpp$

##### 具体功能：

1、索引信息的存储

​		包括索引表头的存储和B树索引的存储。

​		索引表头以$Json$格式存储在（$database.udb$）中，具体的格式如下：

```json
{
    "key": [ //索引建立在那些列上面
        0
    ],
    "key_num": 1,//索引列数
    "name": "index1",//索引名
    "next_del_page": 4294967295,
    "offset": [//取出对应列需要的偏移
        0
    ],
    "page_num": 1,//已经使用的页个数
    "record_size": 8,//单个索引值长度
    "root_page": 0,//B树根节点位置
    "ty": [//索引对应的列的类型
        0
    ]
}
```

​		索引的内容，即B树的各个节点，实际上是按照页来分配的，也就是说，每一个页就对应了一个B树的节点，每一个节点上要记录$fa\_index$（父节点节点号），$record\_cnt$（当前节点索引个数），之后按照孩子编号-RID-索引值-孩子编号-RID-索引值的顺序存储B树节点的信息。

2、索引功能的实现

​		实际上就是B树的实现，包括查询，删除，增加，以及内部需要的上溢下溢等等。由于是一个标准的实现就不多做阐述。

##### （3）系统管理模块

​		系统管理模块主要负责对数据库和数据表进行管理。支持主外键的创建和删除，列的添加、修改和删除。

​		这一部分的代码主要由以下几个文件构成：

​		$Database.cpp$ $Database.h$ $Sheet.cpp$ $Sheet.h$

##### （4）查询解析模块

​		查询解析模块主要利用$Lex/Yacc$完成了$SQL$语句的解析，将语句转化为对数据库其他模块的操作最终完成数据库的功能。从使用上看，这一部分实际上相当于数据库的入口，所有的使用都通过这一模块解析，并反馈结果或者报错给用户。

​		这一部分代码主要由以下几个文件构成：

​		$Lex/Yacc$解析：$yacc.y$ $lex.l$ $parser.h$

​		输出格式的控制：$Print.cpp$ $Print.h$

#### 3、主要模块接口说明



#### 4、实验结果

#### 5、小组分工

潘俊臣：文档编写，索引模块编写，查询解析模块部分代码编写

郑林楷：记录管理模块，系统管理模块，查询解析模块部分代码编写

#### 6、参考文献及使用的开源代码

（1）$Lex/Yacc$

查询解析模块的实现中我们利用了现成的工具，即$Lex/Yacc$实现了$SQL$文法的解析。

（2）$JSON\ for\ Modern\ C++$

开源库地址： https://github.com/nlohmann/json

在实现一些配置信息的存储时（比如表的列信息，索引的列信息，数据库的信息等等），我们使用了一个$JSON$的开源库。将这些只需要单次读取的配置信息的存储简化，不使用提供的文件管理系统。